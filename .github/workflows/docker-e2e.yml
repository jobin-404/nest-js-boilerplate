name: NestJS API CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set Up Swap Space (Prevent OOM Issues)
        run: |
          sudo fallocate -l 2G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          free -m  # Show available memory

      - name: Start Services (Postgres, API)
        run: |
          docker compose -f docker-compose.ci.yaml --env-file env-example -p ci up -d postgres api

      - name: Wait for Services to be Ready
        run: |
          echo "Waiting for Postgres to be ready..."
          timeout 60s sh -c 'until docker compose -p ci exec -T postgres pg_isready -U ${DATABASE_USERNAME} -d ${DATABASE_NAME}; do sleep 2; done'

          echo "Waiting for API to be ready..."
          timeout 60s sh -c 'until docker compose -p ci exec -T api curl -s http://localhost:${APP_PORT}/api; do sleep 5; echo "Waiting..."; done'

      - name: Run E2E Tests
        run: |
          docker compose -p ci exec -T api pnpm test:e2e -- --runInBand

      - name: Cleanup (Stop & Remove Containers)
        if: always()
        run: |
          docker compose -p ci down -v
